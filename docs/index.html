<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Spider-Chart Generator (Draggable)</title>

  <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
  <script defer src="https://pyscript.net/latest/pyscript.js"></script>
  <py-config>
    packages = ["matplotlib", "numpy"]
  </py-config>

  <style>
    body { font-family: sans-serif; padding: 1rem; }
    #chart { display: block; margin: 1rem auto; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Drag the points to edit your spider chart</h1>
  <img id="chart" alt="Spider chart will render here">
  <py-script>
import matplotlib.pyplot as plt
import numpy as np
import io, base64
from js import document, console

# --- 1. Data & state ---
labels = ['A','B','C','D','E']
values = [5]*len(labels)
dragging = None  # which axis index we’re dragging

# --- 2. Draw function ---
def draw_chart():
    angles = np.linspace(0, 2*np.pi, len(labels), endpoint=False).tolist()
    vals_loop = values + values[:1]
    angs_loop = angles + angles[:1]

    fig, ax = plt.subplots(subplot_kw={'polar':True})
    ax.plot(angs_loop, vals_loop, 'o-', linewidth=2)
    ax.fill(angs_loop, vals_loop, alpha=0.25)
    ax.set_thetagrids(np.degrees(angles), labels)
    ax.set_ylim(0, 10)

    buf = io.BytesIO()
    fig.savefig(buf, format="png", bbox_inches="tight")
    plt.close(fig)
    data = base64.b64encode(buf.getvalue()).decode('ascii')
    document.getElementById('chart').src = "data:image/png;base64," + data

# --- 3. Helpers to map pointer → axis & value ---
def pointer_to_polar(evt):
    img = document.getElementById('chart')
    rect = img.getBoundingClientRect()
    cx, cy = rect.width/2, rect.height/2
    x = evt.clientX - rect.left
    y = evt.clientY - rect.top
    dx, dy = x - cx, cy - y  # invert y so up is positive
    angle = np.arctan2(dy, dx) % (2*np.pi)
    dist  = np.hypot(dx, dy)
    return angle, dist, rect.width/2

def find_axis(angle):
    sector = 2*np.pi / len(labels)
    return int(((angle + sector/2) // sector) % len(labels))

# --- 4. Event handlers ---
def on_pointer_down(evt):
    global dragging
    angle, dist, maxr = pointer_to_polar(evt)
    idx = find_axis(angle)
    # only start drag if near the current point (> 70% of radius)
    if abs(dist - (values[idx]/10*maxr)) < maxr*0.15:
        dragging = idx

def on_pointer_move(evt):
    global dragging
    if dragging is None:
        return
    angle, dist, maxr = pointer_to_polar(evt)
    # clamp into [0,10]
    new_val = min(max(int((dist/maxr)*10), 0), 10)
    values[dragging] = new_val
    draw_chart()

def on_pointer_up(evt):
    global dragging
    dragging = None

# --- 5. Wire it up ---
chart = document.getElementById('chart')
chart.addEventListener('pointerdown', on_pointer_down)
chart.addEventListener('pointermove', on_pointer_move)
chart.addEventListener('pointerup',   on_pointer_up)

# initial render
draw_chart()
  </py-script>
</body>
</html>
